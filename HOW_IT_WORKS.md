# HOW IT WORKS: Пошаговая логика системы

Здесь описан жизненный цикл одного "хода" (Turn) в диалоге, от ввода пользователя до ответа системы.

## Ход 0. Управление Памятью (Memory Check)
Перед обработкой нового сообщения система проверяет длину диалога.
* Если **> 6 ходов**: Вызывается **SummarizerAgent**.
* Он сжимает старые сообщения в краткое резюме ("Кандидат рассказал про опыт с Django...").
* В контекст агентов подается: [Summary] + [Last 2 Turns]. Это экономит токены без потери смысла.

## Ход 1. Ввод пользователя
Кандидат пишет сообщение (например: *"В Python списки изменяемые, а кортежи нет"*).
Система перехватывает ввод в `src/main.py`.

## Ход 2. Параллельный Анализ (Hidden Reflection)
Система запускает двух агентов параллельно. Они "не видят" друг друга, но видят сообщение пользователя.

* **FactChecker** использует гибридный подход:
    1. **Поиск в ChromaDB**: Ищет подтвержденные факты в векторной базе.
    2. **Собственные знания (LLM)**: Если в базе пусто, использует свои внутренние знания для проверки.
    * *Вердикт*: "Confirmed. Lists are mutable..." (Found in DB) или "Plausible based on general knowledge" (If DB is empty).
* **Psychologist** анализирует стиль.
    * *Вердикт*: "Candidate is confident and accurate. No stress markers."

## Ход 3. Стратегическое Планирование (The Brain)
Все данные передаются **MentorAgent**.
* **Входные данные Ментора**:
    * История: О чем говорили раньше.
    * Факты: "Кандидат прав".
    * Психология: "Кандидат уверен".
* **Размышление Ментора ("Мысли")**:
    * "Окей, базу он знает. Нужно копнуть глубже. Спрошу про внутреннее устройство памяти или GIL."
* **Инструкция (Output)**:
    * *Instruction*: "Ask about GIL and threading limitations."
    * *Tone*: "Professional scrutiny."

## Ход 4. Генерация и Цензура (The Voice & The Judge)
1. **InterviewerAgent** генерирует черновик ответа: *"Расскажи про GIL."*
2. Включается **JudgeAgent** (LLM-as-a-Judge):
    * Проверяет черновик на безопасность, соответствие тону Ментора и отсутствие галлюцинаций.
    * Если **Rejected**: Отправляет на перегенерацию с критикой.
    * Если **Approved**: Ответ уходит пользователю.

## Ход 5. Логирование
В файл логов записывается не только диалог, но и скрытые мысли:
```json
{
  "user": "В Python списки изменяемые...",
  "internal": "[FactCheck: True] | [Psych: Confident] | [Mentor: Ask about GIL]",
  "response": "Расскажи про GIL..."
}
```

---

## Финал: Decision Maker
Когда пользователь пишет "Стоп" или "Stop Game":
1. Цикл прерывается.
2. Весь накопленный лог (включая скрытые мысли Ментора!) передается **DecisionMakerAgent**.
3. Он считает баллы:
    * **Hard Skills**: + за правильные ответы (подтвержденные FactChecker).
    * **Soft Skills**: + за честность и ясность (от Psychologist).
4. Выдается финальный Markdown-отчет с грейдом (Junior/Middle/Senior).
